<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>webapp</title>
    <!-- Firebase compat SDKs are required so the Unity FirebaseWebGL bridge can call firebase.* APIs -->
    <script src="/firebase/firebase-app-compat.js"></script>
    <script src="/firebase/firebase-auth-compat.js"></script>
    <script src="/firebase/firebase-firestore-compat.js"></script>
    <script src="/firebase/firebase-analytics-compat.js"></script>
    <script src="/firebase/firebase-remote-config-compat.js"></script>
    <script>
      (function setFirebaseDebugFlag() {
        try {
          const host = window.location.hostname.toLowerCase();
          const prodSuffixes = [".apps.tossmini.com", ".private-apps.tossmini.com"];
          const isProd = prodSuffixes.some((suf) => host.endsWith(suf));
          if (!isProd) {
            localStorage.setItem("firebase:debug", "true");
            console.log("[Firebase] Debug mode enabled (non-prod host):", host);
          }
        } catch (e) {
          console.warn("[Firebase] Failed to set debug flag", e);
        }
      })();
    </script>
    <script type="module">
      (function initializeFirebase() {
        if (!window.firebase) {
          console.error("[Firebase] SDK failed to load.");
          return;
        }

        if (window.firebase.apps && window.firebase.apps.length > 0) {
          return;
        }

        const firebaseConfig = {
          apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
          authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
          projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
          storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
          messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
          appId: import.meta.env.VITE_FIREBASE_APP_ID,
          measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
        };

        const requiredKeys = [
          "apiKey",
          "authDomain",
          "projectId",
          "storageBucket",
          "messagingSenderId",
          "appId",
        ];

        const missingKeys = requiredKeys.filter((key) => !firebaseConfig[key]);
        if (missingKeys.length > 0) {
          console.warn(
            `[Firebase] Missing config value(s): ${missingKeys.join(", ")}. Firebase won't be initialized.`
          );
          return;
        }

        const app = window.firebase.initializeApp(firebaseConfig);
        window.firebaseApp = app;
        window.firebaseAuth = app.auth();
        window.firebaseFirestore = app.firestore();
        window.firebaseRemoteConfig = app.remoteConfig();

        try {
          if (window.firebase.analytics) {
            window.firebaseAnalytics = window.firebase.analytics(app);
            console.info("[Firebase] Analytics initialized");
            try {
              // Enable debug_mode for non-prod hosts so events appear in DebugView.
              const prodSuffixes = [".apps.tossmini.com", ".private-apps.tossmini.com"];
              const host = window.location.hostname.toLowerCase();
              const isProd = prodSuffixes.some((suf) => host.endsWith(suf));
              if (!isProd && window.gtag && firebaseConfig.measurementId) {
                window.gtag("config", firebaseConfig.measurementId, {debug_mode: true});
                console.info("[Firebase] gtag debug_mode enabled");
              }
            } catch (dbgErr) {
              console.warn("[Firebase] Failed to enable analytics debug_mode", dbgErr);
            }
          } else {
            console.warn("[Firebase] Analytics SDK not available");
          }
        } catch (err) {
          console.warn("[Firebase] Analytics init failed", err);
        }

        try {
          if (window.firebaseRemoteConfig) {
            // Example: 1h minimum fetch interval, defaults can be set as needed.
            window.firebaseRemoteConfig.settings = { minimumFetchIntervalMillis: 3600000 };
            window.firebaseRemoteConfig.defaultConfig = {};
            window.firebaseRemoteConfig
              .fetchAndActivate()
              .then(() => {
                window.FirebaseWebGL = window.FirebaseWebGL || {};
                window.FirebaseWebGL.RCReady = true;
                console.info("[Firebase] Remote Config fetchAndActivate succeeded");
              })
              .catch((err) => {
                window.FirebaseWebGL = window.FirebaseWebGL || {};
                window.FirebaseWebGL.RCReady = false;
                console.warn("[Firebase] Remote Config fetchAndActivate failed", err);
              });
          } else {
            console.warn("[Firebase] Remote Config SDK not available");
          }
        } catch (err) {
          console.warn("[Firebase] Remote Config init failed", err);
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
