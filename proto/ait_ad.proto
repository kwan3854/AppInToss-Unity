syntax = "proto3";

package ait;

// AdService는 Google AdMob 광고 관련 함수를 제공합니다.
// 폴링(Polling) 기반의 비동기 이벤트 처리 아키텍처를 사용합니다.
service AdService {
  // 1. 광고 로드를 시작하고, 해당 작업의 고유 ID를 반환합니다.
  rpc LoadAd (LoadAdRequest) returns (LoadAdResponse);

  // 2. LoadAd로 발급받은 ID를 사용해, 발생한 이벤트들을 주기적으로 가져옵니다.
  rpc PollLoadAdEvents (PollLoadAdEventsRequest) returns (PollLoadAdEventsResponse);

  // 3. 광고 보여주기를 시작하고, 해당 작업의 고유 ID를 반환합니다.
  rpc ShowAd (ShowAdRequest) returns (ShowAdResponse);

  // 4. ShowAd로 발급받은 ID를 사용해, 발생한 이벤트들을 주기적으로 가져옵니다.
  rpc PollShowAdEvents (PollShowAdEventsRequest) returns (PollShowAdEventsResponse);
}

// --- LoadAd ---
message LoadAdRequest {
  string ad_group_id = 1;
}

message LoadAdResponse {
  string operation_id = 1; // 생성된 고유 작업 ID
}

// --- PollLoadAdEvents ---
message PollLoadAdEventsRequest {
  string operation_id = 1; // LoadAd에서 받은 작업 ID
}

message PollLoadAdEventsResponse {
  repeated LoadAdEvent events = 1; // 마지막 폴링 이후 발생한 이벤트 목록
  bool is_finished = 2; // 작업(광고 로드 플로우)이 완전히 종료되었는지 여부
}

message LoadAdEvent {
  message LoadedEvent {
    // 광고 로드 성공 시 ResponseInfo 데이터 포함
    ResponseInfo data = 1;
  }
  message ClickedEvent {}
  message DismissedEvent {}
  message FailedToShowEvent {}
  message ImpressionEvent {}
  message ShowEvent {}

  oneof event {
    LoadedEvent loaded = 1;
    ClickedEvent clicked = 2;
    DismissedEvent dismissed = 3;
    FailedToShowEvent failed_to_show = 4;
    ImpressionEvent impression = 5;
    ShowEvent show = 6;
  }
}

// --- ShowAd ---
message ShowAdRequest {
  string ad_group_id = 1;
}

message ShowAdResponse {
  string operation_id = 1; // 생성된 고유 작업 ID
}

// --- PollShowAdEvents ---
message PollShowAdEventsRequest {
  string operation_id = 1; // ShowAd에서 받은 작업 ID
}

message PollShowAdEventsResponse {
  repeated ShowAdEvent events = 1; // 마지막 폴링 이후 발생한 이벤트 목록
  bool is_finished = 2; // 작업(광고 표시 플로우)이 완전히 종료되었는지 여부
}

message ShowAdEvent {
  message RequestedEvent {}
  message ClickedEvent {}
  message DismissedEvent {}
  message FailedToShowEvent {}
  message ImpressionEvent {}
  message ShowEvent {}
  message UserEarnedRewardEvent {
    string unit_type = 1;
    int32 unit_amount = 2;
  }

  oneof event {
    RequestedEvent requested = 1;
    ClickedEvent clicked = 2;
    DismissedEvent dismissed = 3;
    FailedToShowEvent failed_to_show = 4;
    ImpressionEvent impression = 5;
    ShowEvent show = 6;
    UserEarnedRewardEvent user_earned_reward = 7;
  }
}


// --- Common Data Structures ---
message AdNetworkResponseInfo {
  string ad_source_id = 1;
  string ad_source_name = 2;
  string ad_source_instance_id = 3;
  string ad_source_instance_name = 4;
  string ad_network_class_name = 5;
}

message ResponseInfo {
  string response_id = 1;

  // 광고 미디에이션(Mediation) 환경에서, 여러 광고 네트워크 중 최종적으로 광고 로드에 성공한 '승자' 네트워크의 정보입니다.
  // 만약 로드에 실패하면 이 값은 비어있을 수 있습니다.
  AdNetworkResponseInfo loaded_ad_network_info = 2;

  // 광고 미디에이션에 참여한 '모든' 광고 네트워크의 응답 정보 목록입니다.
  // 디버깅이나 분석 목적으로 유용할 수 있습니다.
  repeated AdNetworkResponseInfo ad_network_info_array = 3;
}
