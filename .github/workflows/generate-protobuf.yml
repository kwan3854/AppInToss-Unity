name: Generate Protobuf Code

on:
  push:
    branches:
      - main
      - development
      - 'feature/**'

jobs:
  build-and-commit:
    runs-on: macos-latest # Mac 전용 실행 파일을 위해 macOS 환경을 사용합니다.
    
    permissions:
      contents: write # Allow the action to push commits

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (Protobuf & pbjs)
        run: |
          brew install protobuf
          npm install -g pbjs

      - name: Make generator executable
        run: chmod +x proto/protoc-gen-webviewrpc

      - name: Generate code from all .proto files
        run: |
          # Unity C# 출력 디렉토리: Assets/AIT-SDK/Generated/
          UNITY_BASE_DIR="${{ github.workspace }}/unity/AIT-SDK-Project/Assets/AIT-SDK/Generated"
          # React TypeScript 출력 디렉토리: src/generated/
          WEBAPP_BASE_DIR="${{ github.workspace }}/webapp/src/generated"
          
          # 나머지 proto 파일들 처리
          for proto_file in $(find proto -name "*.proto" | grep -v ".example"); do
            echo "==== Processing ${proto_file} ===="
            
            # .proto 파일에서 서비스 이름을 추출합니다.
            service_name=$(grep -E '^service' "${proto_file}" | head -n 1 | awk '{print $2}')
            if [ -z "${service_name}" ]; then
              echo "Warning: No service found in ${proto_file}. Skipping."
              continue
            fi
            echo "Found service: ${service_name}"

            # 파일의 기본 이름을 추출합니다. (예: ait_openurl)
            base_name=$(basename "${proto_file}" .proto)

            # 서비스별 출력 디렉터리
            unity_dir="${UNITY_BASE_DIR}/${service_name}"
            webapp_dir="${WEBAPP_BASE_DIR}/${service_name}"
            
            echo "Output directories:"
            echo "  Unity C#: ${unity_dir}"
            echo "  React TS: ${webapp_dir}"
            
            mkdir -p "${unity_dir}" "${webapp_dir}"

            # C# 코드 생성 (Unity용)
            echo "Generating C# code..."
            protoc \
              -Iproto \
              --csharp_out="${unity_dir}" \
              --plugin=protoc-gen-webviewrpc=proto/protoc-gen-webviewrpc \
              --webviewrpc_out=cs_client,cs_server:"${unity_dir}" \
              "${proto_file}"

            # JavaScript 공용 코드 생성 (React용 - pbjs)
            echo "Generating JavaScript protobuf code..."
            npx pbjs \
              "${{ github.workspace }}/${proto_file}" \
              --es6 "${webapp_dir}/${service_name}.js"

            # TypeScript 서버 코드 생성 (React용)
            echo "Generating TypeScript server code..."
            protoc \
              -Iproto \
              --plugin=protoc-gen-webviewrpc=proto/protoc-gen-webviewrpc \
              --webviewrpc_out=ts_server:"${webapp_dir}" \
              "${proto_file}"
            
            echo "Generated files:"
            echo "Unity C#:"
            ls -la "${unity_dir}" || echo "  (none)"
            echo "React TS/JS:"
            ls -la "${webapp_dir}" || echo "  (none)"
            echo "==== Completed ${proto_file} ===="
          done

      - name: Commit and push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-generate protobuf code"
          branch: ${{ github.head_ref || github.ref_name }}
          file_pattern: unity/AIT-SDK-Project/Assets/AIT-SDK/Generated/**/*.cs webapp/src/generated/**/*.js webapp/src/generated/**/*.ts
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions <actions@github.com>"
