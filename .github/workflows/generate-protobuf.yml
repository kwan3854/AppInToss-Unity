name: Generate Protobuf Code

on:
  push:
    branches:
      - main
      - development
      - 'feature/**'

jobs:
  build-and-commit:
    runs-on: macos-latest # Mac 전용 실행 파일을 위해 macOS 환경을 사용합니다.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies (Protobuf & pbjs)
        run: |
          brew install protobuf
          npm install -g pbjs

      - name: Make generator executable
        run: chmod +x proto/protoc-gen-webviewrpc

      - name: Generate code from all .proto files
        run: |
          # common.proto를 먼저 처리 (다른 파일들이 의존할 수 있으므로)
          if [ -f "proto/common.proto" ]; then
            echo "Processing common.proto first..."
            service_name=$(grep -E '^service' "proto/common.proto" | head -n 1 | awk '{print $2}')
            if [ ! -z "${service_name}" ]; then
              echo "Found service: ${service_name}"
              
              csharp_dir="generated/${service_name}/csharp"
              js_dir="generated/${service_name}/javascript"
              mkdir -p "${csharp_dir}" "${js_dir}"
              
              # C# 코드 생성
              protoc \
                -Iproto \
                --csharp_out="${{ github.workspace }}/${csharp_dir}" \
                --plugin=protoc-gen-webviewrpc=proto/protoc-gen-webviewrpc \
                --webviewrpc_out=cs_client,cs_server:"${{ github.workspace }}/${csharp_dir}" \
                "proto/common.proto"
              
              # JavaScript 코드 생성 (절대 경로 사용)
              npx pbjs \
                "${{ github.workspace }}/proto/common.proto" \
                --es6 "${{ github.workspace }}/${js_dir}/${service_name}.js"
              
              protoc \
                -Iproto \
                --plugin=protoc-gen-webviewrpc=proto/protoc-gen-webviewrpc \
                --webviewrpc_out=js_client,js_server:"${{ github.workspace }}/${js_dir}" \
                "proto/common.proto"
            fi
          fi
          
          # 나머지 proto 파일들 처리
          for proto_file in $(find proto -name "*.proto" | grep -v "common.proto"); do
            echo "Processing ${proto_file}..."
            
            # .proto 파일에서 서비스 이름을 추출합니다. (예: OpenURLService, PaymentService)
            # (파일 당 서비스가 하나만 있다고 가정합니다.)
            service_name=$(grep -E '^service' "${proto_file}" | head -n 1 | awk '{print $2}')
            if [ -z "${service_name}" ]; then
              echo "Warning: No service found in ${proto_file}. Skipping."
              continue
            fi
            echo "Found service: ${service_name}"

            # 파일의 기본 이름을 추출합니다. (예: ait_openurl, ait_payment)
            base_name=$(basename "${proto_file}" .proto)

            # 서비스 이름 기반으로 출력 디렉터리를 생성합니다.
            csharp_dir="generated/${service_name}/csharp"
            js_dir="generated/${service_name}/javascript"
            mkdir -p "${csharp_dir}" "${js_dir}"

            # C# 코드 생성
            protoc \
              -Iproto \
              --csharp_out="${{ github.workspace }}/${csharp_dir}" \
              --plugin=protoc-gen-webviewrpc=proto/protoc-gen-webviewrpc \
              --webviewrpc_out=cs_client,cs_server:"${{ github.workspace }}/${csharp_dir}" \
              "${proto_file}"

            # JavaScript 공용 코드 생성 (절대 경로 사용)
            npx pbjs \
              "${{ github.workspace }}/${proto_file}" \
              --es6 "${{ github.workspace }}/${js_dir}/${service_name}.js"

            # JavaScript 클라이언트/서버 코드 생성
            protoc \
              -Iproto \
              --plugin=protoc-gen-webviewrpc=proto/protoc-gen-webviewrpc \
              --webviewrpc_out=js_client,js_server:"${{ github.workspace }}/${js_dir}" \
              "${proto_file}"
          done

      - name: Commit and push generated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-generate protobuf code"
          # 현재 브랜치에 커밋 및 푸시합니다.
          branch: ${{ github.head_ref || github.ref_name }}
          file_pattern: 'generated/**/*.cs generated/**/*.js'
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"
          commit_author: "GitHub Actions <actions@github.com>"
